#!/usr/bin/env python3
import os
import sys
import argparse

from util import Log
from database import Database
from database import Component
from database.database import NoSuchTable, InstanceNotFoundError

def commit_settings(args):
    Log.set_verbosity(args.verbose)
    if args.config:
        Database(args.config)
    else:
        Database()


def main():
    parser = argparse.ArgumentParser(
            description='Loads a ctl component by reading the enviroment'
                    + 'variable SSH_ORIGINAL_COMMAND')
    parser.add_argument('--verbose', '-v',
            default=1,
            action='count',
            help='Increase output level.')
    parser.add_argument('--config', '-c',
            help='Own config file to be used')
            
    args = parser.parse_args()
    commit_settings(args)

    ctl_call = os.getenv('SSH_ORIGINAL_COMMAND')
    if not ctl_call:
        print('Only ssh allowed')
        exit(1)
    ctl_cmd = ctl_call.split()[0]
    ctl_call = ctl_call[ len(ctl_cmd): ]
    try:
        comp = Component.get_exactly(ctl_cmd)
    except (NoSuchTable, InstanceNotFoundError):
        print('Component not found')
    comp.execute(ctl_call)


if __name__ == "__main__":      
    main()
