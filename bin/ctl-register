#!/usr/bin/env python3
import os
import sys
import getopt
from os.path import dirname,abspath
lib_path = dirname(abspath(__file__))  + "/../lib/backend"
sys.path.append(lib_path)
from util import Log
from util.util import add
from util.util import remove
from database.database import Database
from database.user import User

# registriert benutzer mit id und rsa-pub-key.
# FÃ¼gt den Benutzer dabei der DB hinzu und schreibt die .authorized_keys neu

opt = "a:k:r:ov"
long_opt = [ "add=", "key=", "remove=", "overview", "verbose", "version" ]
max_output_level = 2

def usage():
    print("Usage:", sys.argv[0], """[-a <id>|--add=<id> -k <key>|--key=<key>]
    \t [-r <id>|--remove=<id>] 
    \t [-o|--overview]
    \t [-v | --verbose]
    \t [--version]""")

def main():
    try:
        opts, args = getopt.getopt(sys.argv[1:], opt, long_opt)

    except getopt.GetoptError as err:
        # Print help and exit
        print(err)
        usage()
        sys.exit(2)
    output = None
    ss_port = 22
    database = None
    reg_id = "" #will be set during argument parsing
    pubkey = "" #will be set during argument parsing
    required = 0  #checks if all required arguments are give
    add_set = False
    remove_set = False
    overview_set = False

    #o = options, a = arguments
    for o, a in opts:
        if o in ("-c", "--config"):
            import configparser
            config = configparser.Configparser()
            config.read(a)
            database = Database(config.get('Backend','Database'))
        elif o in ("-a", "--add"):
            add_set = True
            if a == None:
                Log.critical("No valid ID specified, Aborting")
                exit(1)
            else:
                Log.debug("Adding ID to cluster")
                required += 1
                reg_id = a
        elif o in ("-k", "--key"):
            if a == None:
                Log.critical("""No valid public key has been specified,
                        Aborting""")
                exit(1)
            else:
                Log.debug("Setting Public Key")
                required += 1
                pubkey = a

        elif o in ("-r", "--remove"):
            remove_set = True
            if a == None:
                Log.critical("No ID specified, Aborting")
                exit(1)
            else:
                Log.debug("Removing Entry with the specified ID")
                required += 1
                reg_id = a
            print("removing",o,a)

        elif o in ("-o", "--overview"):
            overview_set = true
            print("overview",o,a)

        elif o in ("-v", "--verbose"):
            Log.increase_verbosity()
        elif o == "version":
            usage()

    if add_set and required == 2:
        Log.debug("Switching to add context")
        Log.debug(reg_id+ "," +pubkey)
        add(reg_id,pubkey,database)
    elif remove_set and required == 2:
        Log.debug("Switching to remove context")
        remove(reg_id,pubkey,database)
    elif add_set and remove_set and required == 2:
        Log.critical("""It is not possible to add AND remove at the same time,
        Sry""")
    elif required != 2 and required != 0:
        Log.critical("Something went wrong with the ID or the Key")
        usage()
        Log.info("required is: "+str(required)+"")
    #TODO unsicher, ob add+overview erlaubt sein soll    
    elif required != 2 and overview_set:
        Log.debug("Switching to overview context")
        overview()
    else:
        Log.debug("No option has been given, Aborting")
        exit(1)
        
if __name__ == "__main__":
    main()
