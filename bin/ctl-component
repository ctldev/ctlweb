#!/usr/bin/env python3
import argparse

from util.log import Log
from util.parsing import commit_settings
from util.parsing import parent_parser
from database.database import NoSuchTable
from database import Component


def add(args):
    comp = Component.add(args.package)
    try:
        comp.save()
    except NoSuchTable:
        comp.create_table()
        comp.save()


def remove(args):
    try:
        comp = Component.get_exactly(args.component)
    except NoSuchTable:
        comp = None
    if comp:
        comp.remove()
    else:
        Log.error('%s was not found in Database' % args.component)


def overview(args):
    line_width = 79
    table_template = '%-25s| %-52s'
    heading = 'Registered ctl components'.center(line_width)
    heading_sub = '--=============================--'.center(line_width)
    components = []
    try:
        components = Component.get(args.timestamp)
    except NoSuchTable:
        components = []
    print()
    print(heading)
    print(heading_sub)
    print()
    if components:
        print(table_template % ('Name', 'exe'))
        print('-' * line_width)
    elif args.timestamp:
        print('No ctl components where added in timerange.')
    else:
        print('No ctl components are registered.')

    for c in components:
        print(table_template % (c.c_id, c.c_exe))


def push(args):
    components = []
    try:
        components = Component.get(args.timestamp)
    except NoSuchTable:
        components = []
    if components:
        for c in components:
            Log.info('Uploading %s to %s' % (c.c_id, args.url))
            c.upload_to_url(args.url)
    else:
        Log.error('No components to upload')


def main():
    parser = argparse.ArgumentParser(description='Manage ctl components.')
    subparser = parser.add_subparsers(help='Actions that can be done')
      #####################
     # ctl-component add #
    #####################
    add_parser = subparser.add_parser('add',
                                      parents=[parent_parser],
                                      help='Add a ctl component to database'
                                           + ' and storage.')
    add_parser.add_argument('package',
                            metavar='PACKAGE',
                            help='Ctl component package')
    add_parser.set_defaults(func=add)
      ########################
     # ctl-component remove #
    ########################
    remove_parser = subparser.add_parser('remove',
                                         parents=[parent_parser],
                                         help='Remove ctl component from'
                                              + ' database and storage.')
    remove_parser.add_argument('component',
                               metavar='COMPONENT',
                               help='Name of the registered component')
    remove_parser.set_defaults(func=remove)
      ##########################
     # ctl-component overview #
    ##########################
    overview_parser = subparser.add_parser('overview',
                                           parents=[parent_parser],
                                           help='View registered ctlweb'
                                                + ' users.')
    overview_parser.add_argument('--timestamp', '-t',
                                 help='Show only ctlweb components newer than'
                                      + ' timestamp')
    overview_parser.set_defaults(func=overview)
      ######################
     # ctl-component push #
    ######################
    push_parser = subparser.add_parser('push',
                                       parents=[parent_parser],
                                       help='Push ctl component to ctlweb'
                                            + ' frontend.')
    push_parser.add_argument('url',
                             metavar='URL',
                             help='Upload url')
    push_parser.add_argument('--timestamp', '-t',
                             help='Get only ctlweb components newer than'
                                  + ' timestamp')
    push_parser.set_defaults(func=push)
    # Workaround for Python 3.2-3.4 Issue #9694 'optional arguments'
    parser._optionals.title = 'options'

    args = parser.parse_args()
    commit_settings(args)
    args.func(args)


if __name__ == "__main__":
    main()
