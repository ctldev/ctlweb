#!/usr/bin/env python3
#ermöglicht es Module der Datenbank hinzuzufügen

import sys
import getopt
import os

lib_path = os.getcwd() + "/../lib/backend"
sys.path.append( lib_path )
from util.log import Log
from util.util import hash_file
#from util.util import add_component
from util.settings import DEFAULT_CONFIG
from database import Database
from database import Component
from database.database import NoSuchTable
from database.database import DatabaseNotFound

opt = "a:r:c:v"
long_opt = ["add=", 
        "remove=", 
        "config=" ]


def usage():
    print("Usage:", sys.argv[0], """[-a <component.tgz>|--add=<component.tgz>]
           [ -r <component> | --remove=compontent ] | 
           [ -c | --config=<config file>""")


def main():
    Log.streamoutput()
    try:
         opts, args = getopt.getopt(sys.argv[1:], opt, long_opt)
    except getopt.GetoptError as err:
        print(err)
        usage()
        sys.exit(2)

    config = DEFAULT_CONFIG
    MODE = {"add": 0,
            "get" : 1,
            "remove" : 2,
            }
    mode = None
    
    for o, a in opts:
        if o in ("-a", "--add"):
            if mode == None:
                mode = MODE['add']
            else:
                Log.critical("Can't handle more than one function!")
                exit(1)
            if os.path.isfile(a):
                component = a
            else:
                Log.critical("File %s not found" % a)
        elif o in ("-r", "--remove"):
            if mode == None:
                mode = MODE['remove']
            else:
                Log.critical("Can't handle more than one function!")
                exit(1)
            component = a
        elif o == "-v":
            Log.increase_verbosity()
        elif o in ("-c", "--config"):
            if os.path.isfile(a):
                try:
                    Database(a)
                    config = a
                except DatabaseNotFound:
                    Log.critical("Unable to find or create database on %s." \
                            % Database.db_file)
                    exit(1)
            else:
                Log.critical("File %s not found" % a)
                exit(1)
    if mode == None:
        usage()
        exit(1)
    if not Database.db_connection:
        Log.debug("Using default config to initialize database.")
        try:
            Database()
        except KeyError:
            Log.critical("Couldn't find config file")
            exit(1)
        except DatabaseNotFound:
            Log.critical("Unable to find or create database on %s." \
                    % Database.db_file)
            exit(1)
    if mode == MODE['add']:
        try:
            Log.debug("Adding component to database and manifest store")
#            add_component(component, config=config)
        except KeyError as e:
            Log.critical("Unable to add component.")
            exit(1)
    elif mode == MODE['remove']:
        try:
            Log.debug("Removing component from database and manifest store")
#            remove_component(component, config=config)
        except KeyError as e:
            Log.critical("Unable to remove component.")
            exit(1)

if __name__ == "__main__":
    main()            
            
